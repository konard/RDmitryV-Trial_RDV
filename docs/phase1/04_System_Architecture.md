# Архитектура системы "Искусанный Интеллектом Маркетолух"

## 1. Обзор архитектуры

### 1.1 Общая архитектурная схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Web Interface│  │ Admin Panel  │  │  API Documentation   │  │
│  │   (Vue 3)    │  │   (Vue 3)    │  │    (Swagger UI)      │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP/REST
┌─────────────────────────────────────────────────────────────────┐
│                      API Gateway Layer                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              FastAPI Application                          │  │
│  │  - Authentication & Authorization                         │  │
│  │  - Request Validation                                     │  │
│  │  - Rate Limiting                                          │  │
│  │  - API Routing                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                          │
│  ┌────────────────┐  ┌────────────────┐  ┌─────────────────┐  │
│  │  Research      │  │  Report        │  │  User           │  │
│  │  Orchestrator  │  │  Generator     │  │  Management     │  │
│  └────────────────┘  └────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Processing Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │   Data       │  │  AI Agent    │  │   Verification    │    │
│  │  Collection  │  │  (LangChain) │  │     Module        │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │   Market     │  │  Competitor  │  │   Trend           │    │
│  │  Analysis    │  │   Analysis   │  │   Analysis        │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Data Access Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │  SQLAlchemy  │  │    Redis     │  │   S3/MinIO        │    │
│  │    ORM       │  │    Cache     │  │   (File Storage)  │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Data Storage Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │  PostgreSQL  │  │    Redis     │  │   Object Storage  │    │
│  │   (Main DB)  │  │  (Sessions,  │  │   (Reports, Raw   │    │
│  │              │  │   Queue)     │  │     Data Files)   │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   External Services Layer                        │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │  OpenAI /    │  │   Rosstat    │  │   Web Scraping    │    │
│  │  Claude API  │  │     API      │  │    Services       │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐    │
│  │  Email/      │  │   Analytics  │  │   Monitoring      │    │
│  │ Notification │  │   Services   │  │   (Sentry)        │    │
│  └──────────────┘  └──────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 Ключевые архитектурные принципы

1. **Модульность**: Каждый компонент системы изолирован и имеет четко определенный интерфейс
2. **Масштабируемость**: Горизонтальное масштабирование через контейнеризацию
3. **Отказоустойчивость**: Graceful degradation, retry mechanisms, circuit breakers
4. **Безопасность**: JWT-авторизация, HTTPS, валидация входных данных
5. **Наблюдаемость**: Логирование, мониторинг, трейсинг

## 2. Детальное описание слоев

### 2.1 Frontend Layer (Слой представления)

#### Web Interface (Пользовательский интерфейс)
- **Технология**: Vue 3 с TypeScript (Composition API)
- **State Management**: Pinia
- **UI Library**: PrimeVue + PrimeFlex
- **Функционал**:
  - Форма создания нового исследования
  - Дашборд с проектами исследований
  - Просмотр и скачивание отчетов
  - Редактирование параметров исследования

#### Admin Panel (Административная панель)
- **Технология**: Vue 3 с TypeScript (Composition API)
- **Функционал**:
  - Управление пользователями
  - Мониторинг системы
  - Настройки источников данных
  - Статистика использования
  - Логи и аудит

#### API Documentation (Документация API)
- **Технология**: Swagger UI / ReDoc
- **Автогенерация**: Из OpenAPI спецификации FastAPI
- **Доступ**: Публичная документация для разработчиков

### 2.2 API Gateway Layer (Шлюз API)

#### FastAPI Application
- **Основные обязанности**:
  - Маршрутизация запросов
  - Аутентификация и авторизация (JWT tokens)
  - Валидация входящих данных (Pydantic models)
  - Rate limiting (защита от перегрузки)
  - CORS настройка
  - Обработка ошибок

**Эндпоинты (группы)**:
- `/api/v1/auth/*` - Аутентификация
- `/api/v1/research/*` - Управление исследованиями
- `/api/v1/reports/*` - Управление отчетами
- `/api/v1/users/*` - Управление пользователями
- `/api/v1/admin/*` - Административные функции

### 2.3 Business Logic Layer (Слой бизнес-логики)

#### Research Orchestrator (Оркестратор исследований)
- **Обязанности**:
  - Координация процесса исследования
  - Управление жизненным циклом исследования
  - Распределение задач между модулями
  - Агрегация результатов

**Workflow исследования**:
```
1. Создание исследования
   ↓
2. Сбор данных (Data Collection)
   ↓
3. Анализ данных (Analysis)
   ↓
4. Верификация источников (Verification)
   ↓
5. Генерация отчета (Report Generation)
   ↓
6. Экспорт отчета (Export)
```

#### Report Generator (Генератор отчетов)
- **Обязанности**:
  - Формирование структуры отчета по ГОСТ 7.32-2017
  - Заполнение разделов отчета данными
  - Генерация визуализаций (графики, диаграммы)
  - Форматирование согласно стандарту
  - Экспорт в PDF и DOCX

**Модули генератора**:
- `StructureBuilder`: Создание структуры отчета
- `ContentFiller`: Заполнение контентом
- `VisualizationGenerator`: Создание графиков и диаграмм
- `Formatter`: Применение стилей ГОСТ
- `Exporter`: Экспорт в различные форматы

#### User Management (Управление пользователями)
- **Обязанности**:
  - Регистрация и аутентификация
  - Управление профилями
  - Контроль доступа (RBAC)
  - Квоты и лимиты

### 2.4 Processing Layer (Слой обработки)

#### Data Collection Module (Модуль сбора данных)
**Компоненты**:
- **API Connectors**: Интеграция с внешними API
  - `RosstatConnector`: Росстат API
  - `CBConnector`: ЦБ РФ API
  - `HHStatConnector`: hh.ru статистика
  - `FocusConnector`: Контур.Фокус (опционально)

- **Web Scrapers**: Сбор данных с веб-сайтов
  - `NewsScraper`: Новостные порталы
  - `CompetitorScraper`: Сайты конкурентов
  - `ForumScraper`: Профессиональные форумы

- **File Processors**: Обработка файлов
  - `CSVLoader`: CSV файлы
  - `ExcelLoader`: Excel файлы
  - `PDFExtractor`: PDF документы

#### AI Agent Module (Модуль ИИ-агента)
**Технология**: LangChain + LLM (OpenAI GPT-4 / Anthropic Claude)

**Функции**:
- Анализ собранных данных
- Извлечение ключевых инсайтов
- Генерация текстовых разделов отчета
- Анализ тональности
- Суммаризация больших текстов
- Выявление трендов

**Архитектура агента**:
```
LLM (GPT-4/Claude)
    ↑
LangChain Framework
    ↑
Custom Agents:
- MarketAnalysisAgent
- CompetitorAnalysisAgent
- TrendAnalysisAgent
- ConsumerInsightAgent
```

#### Verification Module (Модуль верификации)
**Функции**:
- Проверка достоверности источников
- Проверка актуальности данных
- Перекрестная верификация
- Определение уровня надежности
- Маркировка непроверенных данных

**Компоненты**:
- `SourceValidator`: Оценка надежности источника
- `ActualityChecker`: Проверка актуальности
- `CrossValidator`: Перекрестная проверка
- `ConfidenceScorer`: Оценка уверенности в данных

#### Market Analysis Module (Модуль анализа рынка)
**Функции**:
- Расчет объема и динамики рынка
- Сегментация рынка
- Выявление драйверов и барьеров
- PESTEL-анализ
- Прогнозирование

#### Competitor Analysis Module (Модуль анализа конкурентов)
**Функции**:
- Идентификация конкурентов
- SWOT-анализ
- Сравнительный анализ
- Анализ позиционирования
- Оценка конкурентных преимуществ

#### Trend Analysis Module (Модуль анализа трендов)
**Функции**:
- Выявление трендов в отрасли
- Анализ смежных отраслей
- Технологические тренды
- Социальные и культурные тренды
- Прогнозирование развития

### 2.5 Data Access Layer (Слой доступа к данным)

#### SQLAlchemy ORM
- **Назначение**: Абстракция доступа к БД
- **Модели**:
  - `User`: Пользователи
  - `Research`: Исследования
  - `Report`: Отчеты
  - `DataSource`: Источники данных
  - `CollectedData`: Собранные данные
  - `AnalysisResult`: Результаты анализа

#### Redis Cache
- **Назначение**: Кэширование и очереди задач
- **Использование**:
  - Кэширование результатов API
  - Кэширование статических данных (справочники)
  - Очередь задач (Celery)
  - Сессии пользователей

#### Object Storage (S3/MinIO)
- **Назначение**: Хранение файлов
- **Типы файлов**:
  - Сгенерированные отчеты (PDF, DOCX)
  - Сырые данные (CSV, JSON)
  - Временные файлы обработки
  - Изображения и графики

### 2.6 Data Storage Layer (Слой хранения данных)

#### PostgreSQL (Основная БД)
**Схема данных** (см. раздел 5)

**Таблицы**:
- `users`: Пользователи системы
- `researches`: Маркетинговые исследования
- `reports`: Сгенерированные отчеты
- `data_sources`: Источники данных
- `collected_data`: Собранные данные
- `analysis_results`: Результаты анализа
- `verifications`: Результаты верификации

#### Redis (Кэш и очередь)
- **Использование**:
  - Временные данные
  - Очереди Celery
  - Rate limiting

#### Object Storage
- **Использование**: Файловое хранилище

### 2.7 External Services Layer (Слой внешних сервисов)

#### LLM API (OpenAI / Anthropic)
- **OpenAI GPT-4**: Основной LLM для анализа
- **Anthropic Claude**: Альтернативный/дополнительный LLM
- **Использование**:
  - Анализ текстов
  - Генерация контента
  - Извлечение инсайтов

#### Data Source APIs
- **Росстат API**: Официальная статистика
- **ЦБ РФ API**: Финансовые данные
- **hh.ru API**: Рынок труда
- **Контур.Фокус API**: Данные о компаниях (опционально)

#### Web Scraping Services
- **Scrapy Cloud** (опционально): Облачный скрапинг
- **ScrapingBee** (опционально): Proxy rotation

#### Notification Services
- **Email**: SendGrid / AWS SES
- **Push**: Firebase Cloud Messaging (для будущих мобильных приложений)

#### Monitoring & Analytics
- **Sentry**: Мониторинг ошибок
- **Grafana**: Визуализация метрик
- **Prometheus**: Сбор метрик

## 3. Асинхронная обработка

### 3.1 Celery Task Queue

**Назначение**: Выполнение долгих задач в фоне

**Архитектура**:
```
FastAPI (Producer) → Redis (Broker) → Celery Worker (Consumer)
                                            ↓
                                      PostgreSQL
                                      (Result Backend)
```

**Типы задач**:
1. **Data Collection Tasks**:
   - `collect_rosstat_data`
   - `scrape_competitor_data`
   - `fetch_news_data`

2. **Analysis Tasks**:
   - `analyze_market`
   - `analyze_competitors`
   - `analyze_trends`

3. **Report Generation Tasks**:
   - `generate_report_structure`
   - `fill_report_content`
   - `create_visualizations`
   - `export_to_pdf`
   - `export_to_docx`

4. **Verification Tasks**:
   - `verify_sources`
   - `check_actuality`
   - `cross_validate_data`

**Приоритеты задач**:
- Высокий: Генерация отчетов
- Средний: Анализ данных
- Низкий: Сбор данных (фоновый)

### 3.2 WebSocket для real-time обновлений

**Назначение**: Уведомление клиента о прогрессе

**Использование**:
- Статус выполнения исследования
- Прогресс генерации отчета
- Ошибки и предупреждения

**Технология**: FastAPI WebSocket

## 4. Безопасность

### 4.1 Аутентификация и Авторизация

#### Аутентификация
- **Метод**: JWT (JSON Web Tokens)
- **Access Token**: Срок жизни 15 минут
- **Refresh Token**: Срок жизни 7 дней
- **Хранение**: HttpOnly cookies (frontend)

#### Авторизация (RBAC)
**Роли**:
1. **User**: Обычный пользователь
   - Создание исследований
   - Просмотр своих отчетов
   - Скачивание отчетов

2. **Premium User**: Платный пользователь
   - Все права User
   - Приоритетная обработка
   - Увеличенные квоты
   - Доступ к расширенной аналитике

3. **Admin**: Администратор
   - Все права
   - Управление пользователями
   - Мониторинг системы
   - Настройка параметров

### 4.2 Защита данных

- **HTTPS**: Обязательное шифрование трафика
- **Валидация входных данных**: Pydantic models
- **SQL Injection защита**: SQLAlchemy ORM
- **XSS защита**: Санитизация HTML
- **CSRF защита**: CSRF tokens
- **Rate Limiting**: Ограничение запросов
- **Secrets Management**: Хранение ключей в переменных окружения / Vault

### 4.3 Конфиденциальность

- **GDPR / ФЗ-152**: Соблюдение законов о персональных данных
- **Хэширование паролей**: bcrypt
- **Аудит**: Логирование всех действий пользователей

## 5. Масштабируемость

### 5.1 Горизонтальное масштабирование

**Компоненты, поддерживающие масштабирование**:
- FastAPI (stateless) → Несколько инстансов за load balancer
- Celery Workers → Добавление воркеров по мере нагрузки
- Redis → Кластер Redis
- PostgreSQL → Реплики для чтения

### 5.2 Кэширование

**Уровни кэширования**:
1. **Redis**: Кэш результатов API, справочники
2. **HTTP Cache**: Cache-Control headers
3. **CDN**: Статические файлы (будущее)

### 5.3 Database Optimization

- **Индексы**: На часто запрашиваемые поля
- **Connection Pooling**: SQLAlchemy pool
- **Query Optimization**: Избегание N+1 проблемы
- **Партиционирование**: Для больших таблиц (будущее)

## 6. Мониторинг и наблюдаемость

### 6.1 Логирование

**Уровни логов**:
- DEBUG: Разработка
- INFO: Важные события
- WARNING: Предупреждения
- ERROR: Ошибки
- CRITICAL: Критические сбои

**Инструменты**:
- **Structlog**: Структурированное логирование
- **ELK Stack** (опционально): Elasticsearch, Logstash, Kibana

### 6.2 Мониторинг

**Метрики**:
- Время ответа API
- Количество запросов
- Ошибки (4xx, 5xx)
- Использование ресурсов (CPU, RAM)
- Размер очереди Celery
- Успешность выполнения задач

**Инструменты**:
- **Prometheus**: Сбор метрик
- **Grafana**: Визуализация
- **Sentry**: Мониторинг ошибок

### 6.3 Трейсинг

**Инструменты**:
- **OpenTelemetry** (опционально): Распределенный трейсинг
- **Jaeger** (опционально): Визуализация трейсов

## 7. CI/CD и DevOps

### 7.1 CI/CD Pipeline

**Этапы**:
1. **Lint & Format**: Ruff, Black
2. **Type Check**: MyPy
3. **Unit Tests**: Pytest
4. **Integration Tests**: Pytest + TestContainers
5. **Build**: Docker image
6. **Security Scan**: Trivy, Bandit
7. **Deploy**: К8s / Docker Compose

**Инструменты**:
- **GitHub Actions**: CI/CD
- **Docker**: Контейнеризация
- **Docker Compose**: Локальная разработка
- **Kubernetes** (опционально): Production deployment

### 7.2 Инфраструктура

**Окружения**:
1. **Development**: Локальная разработка
2. **Staging**: Тестовая среда
3. **Production**: Продакшн

**Инфраструктура как код**:
- **Docker Compose**: Локальная разработка
- **Terraform** (опционально): Управление облачной инфраструктурой

## 8. Disaster Recovery

### 8.1 Резервное копирование

**Что бэкапим**:
- База данных PostgreSQL: Ежедневно
- Object Storage: Автоматическая репликация
- Redis: Snapshot

**Хранение бэкапов**:
- Локальные бэкапы: 7 дней
- Удаленные бэкапы: 30 дней

### 8.2 Восстановление

**RTO (Recovery Time Objective)**: < 4 часа
**RPO (Recovery Point Objective)**: < 24 часа

## 9. Технологический стек (итоговый)

### Backend
- **Python**: 3.11+
- **Framework**: FastAPI
- **ORM**: SQLAlchemy
- **Task Queue**: Celery
- **AI/ML**: LangChain, OpenAI API, Anthropic Claude
- **NLP**: spaCy
- **Data Processing**: Pandas, NumPy
- **Web Scraping**: BeautifulSoup4, Scrapy, Playwright
- **Report Generation**: python-docx, ReportLab/WeasyPrint
- **Visualization**: Matplotlib, Plotly

### Frontend
- **Framework**: Vue 3 with TypeScript (Composition API)
- **State Management**: Pinia
- **UI Library**: PrimeVue, PrimeFlex
- **HTTP Client**: Axios
- **Charts**: PrimeVue Chart / Chart.js

### Database & Storage
- **RDBMS**: PostgreSQL 15+
- **Cache & Queue**: Redis 7+
- **Object Storage**: MinIO / S3

### DevOps & Infrastructure
- **Containerization**: Docker, Docker Compose
- **CI/CD**: GitHub Actions
- **Monitoring**: Prometheus, Grafana, Sentry
- **Orchestration**: Kubernetes (опционально)

### External Services
- **LLM**: OpenAI GPT-4, Anthropic Claude
- **Email**: SendGrid / AWS SES
- **Cloud**: AWS / Yandex Cloud (для продакшна)

---

*Документ подготовлен в рамках Фазы 1 проекта "Искусанный Интеллектом Маркетолух"*
*Дата: 02.02.2026*
